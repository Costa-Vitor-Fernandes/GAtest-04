name: Semantic Version Validation

on:
  pull_request:
    types: [opened, edited, synchronize, reopened]

jobs:
  validate-and-predict:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    
    steps:
      - name: Validate Semantic PR
        uses: amannn/action-semantic-pull-request@v5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          validate_single_commit: false
          validate_commits: true
          types: |
            feat
            fix
            chore
            docs
            style
            refactor
            perf
            test
            build
            ci
            revert
          scopes: |
            *
      
      - name: Checkout with full history

        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Node.js

        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Calculate Next Version

        id: calc-version
        working-directory: ./scripts/ci
        run: node calculate-version.js
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          BASE_REF: ${{ github.event.pull_request.base.ref }}
          HEAD_REF: ${{ github.event.pull_request.head.ref }}
      
      - name: Create or Update Version Comment
        if: success() && steps.calc-version.outputs.next_version
        uses: peter-evans/create-or-update-comment@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ## üì¶ Previs√£o de Vers√£o
            
            **Pr√≥xima vers√£o estimada:** `${{ steps.calc-version.outputs.next_version }}`
            
            ### üìä An√°lise:
            ${{ steps.calc-version.outputs.analysis }}
            
            ### ‚ÑπÔ∏è Como isso funciona:
            - ‚ö†Ô∏è **Breaking change**: Incrementa MAJOR (ex: 1.0.0 ‚Üí 2.0.0)
            - ‚ú® **feat**: Incrementa MINOR (ex: 1.0.0 ‚Üí 1.1.0)
            - üêõ **fix**: Incrementa PATCH (ex: 1.0.0 ‚Üí 1.0.1)
            - üìù **outros**: Mant√©m a vers√£o atual
            
            ---
            *Baseado em commits desde a tag `${{ steps.calc-version.outputs.last_version }}`*
          edit-mode: replace
          comment-tag: semantic-version-preview